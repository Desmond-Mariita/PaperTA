{"type":"result","subtype":"success","is_error":false,"duration_ms":49726,"duration_api_ms":49698,"num_turns":1,"result":"\n\n# Phase 1 Build — External Review\n\n## Summary\n\nPhase 1 delivers a deterministic ingestion → retrieval → grounded summary pipeline for a single academic paper. The implementation is well-structured: frozen dataclasses enforce immutability, chunk IDs use a content-hash scheme, and the test matrix covers unit/integration/negative paths across all components. The contract, checklist, source code, and tests are broadly consistent.\n\nHowever, there are several issues ranging from a contract invariant that cannot be verified from the provided code, to missing test files referenced in the checklist, to minor inconsistencies in error messages and normalization behavior.\n\n---\n\n## Findings\n\n### CRITICAL\n\n**(none)**\n\nNo critical defects found. The core pipeline logic is correct, deterministic, and consistent with the contract.\n\n---\n\n### MAJOR\n\n**M-1: Missing negative test files for ingestion and retrieval referenced by checklist**\n- **Severity:** MAJOR\n- **Evidence:** The checklist references:\n  - `tests/negative/test_ingestion_negative.py` (items T-INGEST-NEG-001, F-005) with test `test_ingestion_rejects_duplicate_sections`\n  - `tests/negative/test_retrieval_negative.py` (items T-RETRIEVE-NEG-001, F-003) with test `test_retrieval_rejects_non_positive_top_k`\n- The provided \"TESTS negative\" section contains only `test_pipeline_negative.py` tests (`test_pipeline_rejects_empty_paper`, `test_pipeline_rejects_empty_query`, `test_pipeline_rejects_invalid_mode`) and `test_summary_negative.py` tests (`test_summary_returns_not_stated_when_no_evidence`). The tests for `test_ingestion_negative.py` and `test_retrieval_negative.py` are **not included** in the snapshot.\n- **Impact:** Cannot confirm checklist items T-INGEST-NEG-001, T-RETRIEVE-NEG-001, F-003, F-005 pass. If these files do not exist, 4 checklist gates fail.\n\n**M-2: Missing unit test files for ingestion and retrieval referenced by checklist**\n- **Severity:** MAJOR\n- **Evidence:** The checklist references:\n  - `tests/unit/test_ingestion.py` (item T-INGEST-UNIT-001) with test `test_chunking_assigns_stable_chunk_ids`\n  - `tests/unit/test_retrieval.py` (item T-RETRIEVE-UNIT-001) with test `test_retrieval_orders_by_overlap_score`\n- The provided \"TESTS unit summary\" section only contains `test_summary.py` tests. The ingestion and retrieval unit tests are **not included** in the snapshot.\n- **Impact:** Cannot confirm checklist items T-INGEST-UNIT-001 and T-RETRIEVE-UNIT-001 pass.\n\n---\n\n### MINOR\n\n**m-1: Inconsistent error messages for mode validation between `pipeline.py` and `summary.py`**\n- **Severity:** MINOR\n- **Evidence:**\n  - `pipeline.py`: `raise ValueError(\"invalid mode\")`\n  - `summary.py`: `raise ValueError(\"mode must be 'summary' in phase 1\")`\n- The pipeline checks mode *before* calling `generate_summary`, so the summary-level check is unreachable through the pipeline path. This is not a bug, but the inconsistent messages could confuse debugging. Consider standardizing.\n\n**m-2: Contract specifies \"Empty paper content → ValueError\" but implementation checks emptiness *after* chunking, not on raw input**\n- **Severity:** MINOR\n- **Evidence:** Contract Failure Mode 1 says: `Empty paper content -> ValueError`. In `ingestion.py`, the check is:\n  ```python\n  any_content = False\n  for section in sections:\n      ...\n      for paragraph in paragraphs:\n          normalized_chunk = _normalize_text(paragraph)\n          if not normalized_chunk:\n              continue\n          any_content = True\n          ...\n  if not any_content:\n      raise ValueError(\"paper content is empty\")\n  ```\n  This means a section with text `\"   \"` (whitespace-only) correctly raises `ValueError`, but the check happens *after* normalization, not on the raw `text` field. This is acceptable behavior but the indirection is worth documenting.\n\n**m-3: `_normalize_text` does not collapse `\\r\\n` to `\\n` — that's done separately**\n- **Severity:** MINOR\n- **Evidence:** In `ingestion.py`, `_normalize_text` only does `strip()` + whitespace collapse. The `\\r\\n` → `\\n` conversion is done separately in `ingest_document` via `section.text.replace(\"\\r\\n\", \"\\n\")` before paragraph splitting but *not* before `_normalize_text` is called on individual chunks. If a chunk contains a standalone `\\r` (without `\\n`), `_normalize_text` will collapse it via `\\s+` regex, but the hash input will differ from a version with `\\n`. This is a subtle cross-platform determinism edge case.\n- **Impact:** Low — `\\r` without `\\n` is rare, and `\\s+` collapse handles it, but the chunk text stored in the `Chunk` object will contain a space where a `\\r` was, which is consistent.\n\n**m-4: Retrieval tie-breaking uses `section` then `chunk_id` (string sort), not section order from ingestion**\n- **Severity:** MINOR\n- **Evidence:** `retrieval.py`:\n  ```python\n  scored.sort(key=lambda hit: (-hit.score, hit.section, hit.chunk_id))\n  ```\n  This sorts by section label *alphabetically*, not by the `section_order` from `IngestedPaper`. The integration test `test_pipeline_uses_ingestion_section_order` names sections \"Zeta\" and \"Alpha\" — \"Zeta\" wins because it has a higher overlap score (2 tokens: \"alpha\", \"beta\") vs \"Alpha\" (1 token: \"alpha\"), not because of section order. The test name is therefore misleading — it tests score ordering, not section ordering.\n- **Impact:** If two chunks from different sections have equal scores, the one from the alphabetically-first section wins, regardless of document order. This may not match user expectations for a paper reader. The contract does not specify tie-breaking behavior, so this is not a contract violation.\n\n---\n\n### NIT\n\n**n-1: `_snippet` default `max_len=120` is undocumented in the contract**\n- The truncation length for summary bullet text is an implementation detail with no contract specification. This is fine for Phase 1 but should be noted if summary text stability is expected.\n\n**n-2: `SectionInput` uses `label` and `text` fields but the contract says \"paper text and section labels\" without specifying the data structure**\n- The contract Interface #1 says `ingest_document(paper_id, sections) -> IngestedPaper` but does not specify the type of `sections`. The implementation uses `Sequence[SectionInput]`, which is reasonable.\n\n**n-3: Redundant mode check in pipeline**\n- `run_phase1_pipeline` checks `mode != \"summary\"` and raises `ValueError`, then passes `mode` to `generate_summary` which performs the same check. The pipeline check makes the summary check dead code through the pipeline path. Not harmful, but redundant.\n\n---\n\n## Open Questions\n\n1. **Are `test_ingestion_negative.py` and `test_retrieval_negative.py` actually present on disk?** The review snapshot omits them. If they don't exist, 4 checklist items (T-INGEST-NEG-001, T-RETRIEVE-NEG-001, F-003, F-005) and 2 more (T-INGEST-UNIT-001, T-RETRIEVE-UNIT-001) cannot be verified. This is the most important gap in the review.\n\n2. **Is alphabetical tie-breaking on section labels intentional?** If the project values document-order fidelity (the contract mentions \"section association\"), retrieval tie-breaking should use `section_order` index from `IngestedPaper` rather than alphabetical sort.\n\n3. **Should the contract specify the `SectionInput` type and `_snippet` truncation length?** These are currently implementation details that affect reproducibility if a different implementation were written against the same contract.\n\n---\n\n## Final Verdict\n\n**CONDITIONAL PASS**\n\nThe implementation logic is correct, the contract is well-specified, and the provided tests are sound. The core pipeline is deterministic and all invariants hold in the provided code.\n\nHowever, the review snapshot is **incomplete**: 4 of 6 test files referenced by the checklist are not included in the context (unit tests for ingestion/retrieval, negative tests for ingestion/retrieval). If these files exist and pass, this is a clean pass. If they are missing, 6 checklist gates fail, which would change the verdict to **FAIL**.\n\n**Action required:** Confirm existence and passing status of:\n- `tests/unit/test_ingestion.py::test_chunking_assigns_stable_chunk_ids`\n- `tests/unit/test_retrieval.py::test_retrieval_orders_by_overlap_score`\n- `tests/negative/test_ingestion_negative.py::test_ingestion_rejects_duplicate_sections`\n- `tests/negative/test_retrieval_negative.py::test_retrieval_rejects_non_positive_top_k`","stop_reason":null,"session_id":"751df948-4b70-4108-bf9d-bf0ba2527fb3","total_cost_usd":0.11438550000000001,"usage":{"input_tokens":2,"cache_creation_input_tokens":7398,"cache_read_input_tokens":21676,"output_tokens":2292,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":7398,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"},"modelUsage":{"claude-opus-4-6":{"inputTokens":2,"outputTokens":2292,"cacheReadInputTokens":21676,"cacheCreationInputTokens":7398,"webSearchRequests":0,"costUSD":0.11438550000000001,"contextWindow":200000,"maxOutputTokens":32000}},"permission_denials":[],"uuid":"43eb3ba8-60d8-42b3-8f3a-d5f02e9fa719"}
