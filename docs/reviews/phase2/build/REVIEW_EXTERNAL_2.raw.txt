{"type":"result","subtype":"success","is_error":false,"duration_ms":49794,"duration_api_ms":49743,"num_turns":11,"result":"---\n\n# Phase 2 Build — External Review\n\n## Summary\n\nPhase 2 adds a deterministic Teach Mode pipeline on top of the Phase 1 ingestion/retrieval foundation. The build introduces 6 new teach artifacts (prerequisites, concept map, explanation, quiz, Socratic Q&A) with frozen dataclass contracts, evidence-anchored chunk IDs throughout, and graceful `NOT_STATED` degradation. The code is well-structured, deterministic, and consistent with Phase 1 patterns. There are a handful of gaps in test coverage and one contract specification that is not enforced at runtime.\n\n---\n\n## Findings\n\n### MAJOR\n\n**M1 — Missing test coverage for `generate_explanation` and `generate_quiz`**\nThe unit test file (`tests/unit/test_teach.py`) only covers `generate_prerequisites` and `generate_concept_map`. There are no dedicated unit tests for `generate_explanation` or `generate_quiz`. The integration test exercises these indirectly through the pipeline, but individual correctness (edge structure, answer-key validity, step ordering) is not asserted.\n\n> Evidence: `tests/unit/test_teach.py` contains only `test_generate_prerequisites_with_citations` and `test_generate_concept_map_links_nodes`. Neither `generate_explanation` nor `generate_quiz` appears.\n\nThe ADR validation plan explicitly calls for these:\n> `docs/adr/ADR-002-phase2-teach-mode-core.md:45` — \"Unit tests for prerequisite extraction, concept mapping, **quiz construction**, and socratic constraints.\"\n\n**M2 — Missing negative test for `top_k <= 0` and invalid mode**\nThe runtime contract (`docs/contracts/PHASE2_RUNTIME_CONTRACT.md:41-42`) specifies:\n> \"Empty objective -> ValueError\", \"top_k <= 0 -> ValueError\", \"Invalid mode (not teach) -> ValueError\"\n\nOnly the empty-objective case has a negative test (`test_phase2_pipeline_rejects_empty_objective`). The `top_k <= 0` and invalid-mode failure paths (`teach.py:275-280`) are untested.\n\n**M3 — Contract specifies \"Empty paper content -> ValueError\" but no enforcement exists**\n> `docs/contracts/PHASE2_RUNTIME_CONTRACT.md:43` — \"Empty paper content -> ValueError.\"\n\nThere is no validation in `run_phase2_teach_pipeline` for empty `sections`. Passing `sections=()` will not raise `ValueError` from Phase 2 code; it depends on whether `ingest_document` happens to raise. This is an unverified assumption and has no test.\n\n---\n\n### MINOR\n\n**m1 — `answer_socratic_question` positive-path unit test missing**\nThe only socratic test is the negative case (`test_socratic_returns_not_stated_when_unsupported`). There is no test confirming a supported question returns a grounded answer with non-empty `chunk_ids`. This is called out in the ADR validation plan as \"socratic constraints\" but only the refusal side is tested.\n\n**m2 — MCQ `answer_key` correctness is not structurally enforced**\n`MCQItem.answer_key` is a free `str` field (`teach_contracts.py:73`). The contract invariant states:\n> `PHASE2_RUNTIME_CONTRACT.md:36` — \"Quiz answer keys must correspond to generated options/prompts.\"\n\nIn `generate_quiz` (`teach.py:212`), the answer key is set to `first_hit.section`, which is also `options[0]`, so it is correct by construction. However, since the dataclass imposes no `__post_init__` check, any future caller constructing `MCQItem` manually could violate the invariant silently.\n\n**m3 — `_snippet` truncation could split mid-word**\n`teach.py:69` — `text[: max_len - 3].rstrip() + \"...\"` truncates by character count, which can cut in the middle of a word. This is cosmetic for deterministic stubs but worth noting for future human-readable output.\n\n**m4 — Pipeline facade in `pipeline.py` is a pure passthrough with no added validation**\n`pipeline.py:57-82` — `run_phase2_teach_pipeline` delegates entirely to `_run_phase2_teach_pipeline` with no additional checks. The `Raises:` section is absent from its docstring (unlike the inner implementation), which could confuse callers expecting documented error semantics.\n\n> `pipeline.py:64-75`: docstring lists `Returns` but omits `Raises`, while the inner function at `teach.py:273` documents `Raises: ValueError`.\n\n---\n\n### NIT\n\n**n1 — Stopword list includes domain-leaky words**\n`teach.py:49-50` includes `\"paper\"` and `\"say\"` as stopwords. These are reasonable for academic Q&A but would need revisiting if the system is generalized beyond paper analysis.\n\n**n2 — Checklist uses `test_exists` evidence type but no `test_passes` gate**\n`PHASE2_ACCEPTANCE_CHECKLIST.yaml` verifies test existence (file + function name present) but not that they pass. The passing gate depends on the separate `pytest -q` verification result rather than being self-contained in the checklist.\n\n**n3 — ADR-002 has a minor grammar issue**\n> `docs/adr/ADR-002-phase2-teach-mode-core.md:26` — \"Rejected due weak auditability\" → should be \"Rejected due **to** weak auditability\".\n\n---\n\n## Open Questions\n\n1. **Should `run_phase2_teach_pipeline` explicitly validate `sections` is non-empty?** The contract promises `ValueError` for empty paper content, but enforcement is implicit via `ingest_document`. If ingestion ever changes to accept empty input, the teach pipeline would silently degrade.\n\n2. **Are unit tests for `generate_explanation` and `generate_quiz` planned for a follow-up loop, or are they expected in this build?** The ADR validation plan lists them, but the checklist does not require them by ID.\n\n3. **Should the MCQ `answer_key` membership in `options` be enforced structurally (e.g., via `__post_init__`)?** Currently correct by construction but fragile against future changes.\n\n---\n\n## Final Verdict\n\n**CONDITIONAL PASS** — The implementation is well-designed, deterministic, and structurally sound. The contracts, dataclasses, and pipeline orchestration follow Phase 1 conventions faithfully. However, three MAJOR gaps must be addressed before merge:\n\n1. Add unit tests for `generate_explanation` and `generate_quiz` (M1).\n2. Add negative tests for `top_k <= 0` and invalid mode (M2).\n3. Either add explicit empty-sections validation in the teach pipeline or add a test proving `ingest_document` rejects it, and document the dependency (M3).\n\nOnce these are resolved, the phase gate can be marked PASS.","stop_reason":null,"session_id":"98bdbb58-b6ce-4a53-9314-5eae131eeb42","total_cost_usd":0.1800385,"usage":{"input_tokens":4,"cache_creation_input_tokens":13232,"cache_read_input_tokens":78587,"output_tokens":2321,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":13232,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"},"modelUsage":{"claude-opus-4-6":{"inputTokens":4,"outputTokens":2321,"cacheReadInputTokens":78587,"cacheCreationInputTokens":13232,"webSearchRequests":0,"costUSD":0.1800385,"contextWindow":200000,"maxOutputTokens":32000}},"permission_denials":[],"uuid":"d0bc38d5-7581-4f64-9b69-2c630c55c4fe"}
