# External Review (claude)

- Generated at: 2026-02-17T10:42:36+00:00
- Command: `claude -p --output-format json --dangerously-skip-permissions`
- Input mode: `stdin`
- Exit code: 0
- Raw file: `REVIEW_EXTERNAL_2.raw.txt`
- Raw SHA256: `a02cd33b67f591f2df2f3c902d26847a3b1814a4aa3dedd37647081a99cc8da4`

## Raw Output

```text
{"type":"result","subtype":"success","is_error":false,"duration_ms":36837,"duration_api_ms":36803,"num_turns":1,"result":"\n\n# Phase 4 Design Review — Multi-Paper Intelligence\n\n## Summary\n\nPhase 4 proposes a deterministic multi-paper intelligence layer with concept linking, consensus classification, and a cross-paper graph. The design is well-structured, follows the established phase progression pattern, and maintains the project's deterministic-auditability stance. However, there are several gaps in the contract and test coverage that should be addressed before proceeding to build.\n\n---\n\n## Findings\n\n### CRITICAL\n\n**None.**\n\n### MAJOR\n\n**M1. Missing negative test for empty query (Failure Mode 2 not covered)**\n- Severity: **MAJOR**\n- The Runtime Contract explicitly declares `Empty query -> ValueError` as Failure Mode 2, but the Acceptance Checklist contains no test item verifying this behavior.\n- Evidence: Contract states `2. Empty query -> ValueError.` under `## Failure Modes`, but checklist items `T4-NEG-001` and `T4-NEG-002` only cover empty paper set and insufficient evidence — no `test_phase4_pipeline_rejects_empty_query`.\n- Impact: A declared invariant would ship without automated verification.\n\n**M2. Missing negative tests for `top_k <= 0` and invalid mode**\n- Severity: **MAJOR**\n- Failure Modes 3 and 4 (`top_k <= 0 -> ValueError`, `Invalid mode (not multi_paper) -> ValueError`) are contractually required but have zero corresponding checklist test items.\n- Evidence: `## Failure Modes` items 3 and 4 in the Runtime Contract have no matching `T4-NEG-*` entries in the checklist.\n- Impact: Two additional declared error paths would be untested at the acceptance gate.\n\n**M3. No unit test for `CrossPaperGraphService`**\n- Severity: **MAJOR**\n- The ADR names four components: `ConceptLinkerService`, `ConsensusService`, `CrossPaperGraphService`, and `MultiPaperPipeline`. The checklist has unit tests for concept linking (`T4-UNIT-001`) and consensus (`T4-UNIT-002`), but none for graph construction.\n- Evidence: ADR `## Decision` item 3: `CrossPaperGraphService: emits deterministic edges between papers and canonical concepts.` — no `T4-UNIT-003` exists.\n- Impact: A core component with its own determinism guarantee has no dedicated unit-level verification.\n\n### MINOR\n\n**m1. Contract interface signature inconsistency with ADR component names**\n- Severity: **MINOR**\n- The ADR names service classes (`ConceptLinkerService`, `ConsensusService`, `CrossPaperGraphService`, `MultiPaperPipeline`), but the contract `## Interfaces` section exposes bare functions (`link_concepts`, `build_consensus_matrix`, `build_cross_paper_graph`, `run_phase4_multi_paper_pipeline`). This is not necessarily wrong, but the mapping between the two is implicit.\n- Evidence: ADR item 1 says `ConceptLinkerService`; Contract says `link_concepts(paper_results) -> ConceptLinkResult`.\n- Recommendation: Clarify whether services are classes with these methods or if the functions are the public API. The build loop implementer needs this disambiguated.\n\n**m2. Fallback text invariant may be ambiguous for multi-paper context**\n- Severity: **MINOR**\n- The fallback text is `Not stated in the paper.` (singular \"the paper\"), inherited from earlier single-paper phases. In a multi-paper context, this could be misleading — does it mean not stated in *any* paper, or not stated in a *specific* paper?\n- Evidence: Contract `## Invariants` item 3: `Fallback text is exact: Not stated in the paper.`\n- Recommendation: Consider whether multi-paper fallback text should be distinct (e.g., `Not stated in any of the input papers.`) or document that the singular form is intentional and scoped per-paper.\n\n**m3. `ConceptLinkResult` return type not described**\n- Severity: **MINOR**\n- The contract lists `link_concepts(paper_results) -> ConceptLinkResult` but does not describe the shape of `ConceptLinkResult`. Similarly, `ConsensusMatrix`, `CrossPaperGraph`, and `MultiPaperPipelineResult` are referenced but not structurally defined.\n- Evidence: `## Interfaces` section — all four return types are named but unspecified.\n- Recommendation: Add a `## Data Structures` section or defer to the contracts module, but state that explicitly.\n\n### NIT\n\n**n1. ADR typo: \"due deterministic-auditability\"**\n- Severity: **NIT**\n- Evidence: ADR `## Alternatives Considered`, item 1: `Rejected for initial phase due deterministic-auditability requirements.`\n- Should read: `due to deterministic-auditability requirements.`\n\n**n2. Checklist version could reference the phase contract version**\n- Severity: **NIT**\n- The checklist has `version: \"1.0\"` but no linkage to the contract it validates. A `contract_ref` field would improve traceability.\n\n---\n\n## Open Questions\n\n1. **Concept ID stability**: How are canonical global concept IDs generated? If lexical (e.g., normalized string), what normalization rules apply? This affects determinism claims and should be specified before build.\n\n2. **Paper identity**: What uniquely identifies a \"paper\" in the multi-paper set? File path? Hash? Title? The contract says `papers` as input but doesn't define the paper identity model — duplicates and ordering could break determinism.\n\n3. **Consensus algorithm specifics**: The contract declares four consensus labels but does not specify the decision rules. What thresholds distinguish `mixed` from `contradicting`? Is this intentionally deferred to the build loop?\n\n4. **Graph edge types**: The contract mentions `paper-concept` and `paper-paper` relationship edges. Are edge types enumerated? What qualifies as a `paper-paper` edge versus two papers merely sharing a concept?\n\n5. **Graceful degradation shape**: Failure Mode 5 says artifacts \"degrade gracefully with fallback entries\" when all retrievals are empty. What does the `ConsensusMatrix` look like in this case — empty? All `insufficient evidence`? This needs specification to be testable.\n\n---\n\n## Final Verdict\n\n**CONDITIONAL PASS** — The design is architecturally sound and consistent with the project's phased approach. However, three MAJOR findings must be resolved before the build loop begins:\n\n1. Add negative test checklist items for empty query, invalid `top_k`, and invalid mode (aligning checklist coverage to all five declared failure modes).\n2. Add a unit test checklist item for `CrossPaperGraphService` / `build_cross_paper_graph`.\n3. Clarify the ADR-to-contract mapping (services vs. functions) so the build implementer has an unambiguous target.\n\nOnce these are addressed, the phase is clear to proceed to build.","stop_reason":null,"session_id":"351abbf8-ca3a-49fa-8aee-767d620d8f32","total_cost_usd":0.07502925,"usage":{"input_tokens":2,"cache_creation_input_tokens":3585,"cache_read_input_tokens":21676,"output_tokens":1671,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":3585,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"},"modelUsage":{"claude-opus-4-6":{"inputTokens":2,"outputTokens":1671,"cacheReadInputTokens":21676,"cacheCreationInputTokens":3585,"webSearchRequests":0,"costUSD":0.07502925,"contextWindow":200000,"maxOutputTokens":32000}},"permission_denials":[],"uuid":"e682f04d-3d24-4d56-b91c-586098729fd7"}
```
