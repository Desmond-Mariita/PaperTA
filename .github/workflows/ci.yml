name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - name: Install deps
        run: pip install -e ".[dev]"
      - name: Enforce Google-style docstrings
        run: python3 scripts/check_docstrings.py --paths src/paperta
      - name: Run tests
        run: |
          if [ -d tests ]; then
            pytest tests/ -v --tb=short
          else
            echo "No tests directory yet. Skipping."
          fi

  internal-review-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"
      - name: Install deps
        run: pip install -e ".[dev]"
      - name: Extract phase and loop from branch
        id: extract
        run: |
          BRANCH="${{ github.head_ref }}"
          PHASE=$(echo "$BRANCH" | sed -n 's/phase-\([0-9]*\)-.*/\1/p')
          if [ -z "$PHASE" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          if echo "$BRANCH" | grep -q "loop-1-design"; then
            LOOP="design"
          elif echo "$BRANCH" | grep -q "loop-2-build"; then
            LOOP="build"
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "phase=${PHASE}" >> $GITHUB_OUTPUT
          echo "loop=${LOOP}" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
      - name: Verify internal reviews
        if: steps.extract.outputs.skip != 'true'
        run: |
          python3 scripts/verify_internal_reviews.py \
            --phase ${{ steps.extract.outputs.phase }} \
            --loop ${{ steps.extract.outputs.loop }}
