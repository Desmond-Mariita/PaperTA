name: Phase Gate

on:
  workflow_dispatch:
    inputs:
      phase:
        description: "Phase number to verify"
        required: true
        type: number
      loop:
        description: "Loop to verify"
        required: true
        type: choice
        options: [design, build]
  push:
    branches:
      - "phase-*-loop-1-design"
      - "phase-*-loop-2-build"

jobs:
  phase-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"
      - run: pip install -e ".[dev]"
      - name: Extract phase and loop
        id: extract
        run: |
          if [ -n "${{ inputs.phase }}" ]; then
            PHASE=${{ inputs.phase }}
            LOOP=${{ inputs.loop }}
          else
            BRANCH="${GITHUB_REF##*/}"
            PHASE=$(echo "$BRANCH" | sed -n 's/phase-\([0-9]*\)-.*/\1/p')
            if echo "$BRANCH" | grep -q "loop-1-design"; then
              LOOP="design"
            else
              LOOP="build"
            fi
          fi
          echo "phase=${PHASE:-0}" >> $GITHUB_OUTPUT
          echo "loop=${LOOP:-design}" >> $GITHUB_OUTPUT
      - name: Run phase report
        run: |
          python3 scripts/generate_phase_report.py \
            --phase ${{ steps.extract.outputs.phase }} \
            --loop ${{ steps.extract.outputs.loop }}
      - name: Upload report artifact
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: phase-${{ steps.extract.outputs.phase }}-report
          path: reports/phase${{ steps.extract.outputs.phase }}/
